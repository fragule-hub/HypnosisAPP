## 目标

* 使 HypnosisAPP 通过“设置面板”中的控件实时操控“波纹”和“心”两个子场景的参数与行为。

* 在启动和窗口尺寸变化时，自动将“波纹”的控件尺寸与着色器 tex\_size 同步为窗口大小。

## 场景结构识别

* 根节点：`HypnosisAPP` (Node2D)

* 子场景实例：`波纹`、`心`

* 设置面板控件（均带唯一名）：

  * 基础设置：`%全屏`、`%心`、`%心跳`、`%纯色`、`%波纹速度`、`%心跳速度`、`%心跳幅度`、`%心大小`

  * 波纹颜色设置：`%颜色数量`、`%颜色选项1`、`%颜色选项2`、`%颜色选项3`、`%颜色选项4`

    * 每个“颜色选项X”包含：`ColorPickerButton` 与 `SpinBox`

  * 心设置：`%填充颜色`、`%内边框颜色`、`%外边框颜色`

    * 三项分别包含：`ColorPickerButton` 与 `SpinBox`（内/外边框宽度）

## 参数映射规则

* 全屏：`toggled` 时使用 `DisplayServer.window_set_mode(DisplayServer.WINDOW_MODE_FULLSCREEN)` / `WINDOW_MODE_WINDOWED`。

* 心可见：`%心.toggled` → `心.visible = bool`。

* 心跳开关：`%心跳.toggled` → 调用 `心.set_heartbeat(bool)`。

* 纯色模式：`%纯色.toggled` →

  * 设 `波纹.set_single_color_enabled(true/false)`；

  * 为 `true` 时将 `single_color` 设为“颜色选项1”的颜色；隐藏其他颜色选项控件；

  * 为 `false` 时恢复按“颜色数量”显示相应颜色选项。

* 波纹速度：`%波纹速度.value_changed(v)` → `波纹.set_speed(v)`。

* 心跳速度：UI 每 0.1 → 着色器 0.01：`shader_value = ui_value * 0.1` → 设置 `心.pulse_speed = ui_value * 0.1`。

* 心跳幅度：同映射 → `心.pulse_amount = ui_value * 0.1`。

* 心大小：UI 每 10 → 尺寸 100：`size = ui_value * 10` → `心.target_size = Vector2(size, size)` 并应用布局。

* 波纹颜色设置：

  * `颜色数量` 控制显示的“颜色选项”数量与着色器 `color_count`；

  * 每个“颜色选项X”：

    * 颜色 → 写入 `rings.colors[X-1]`

    * 厚度 SpinBox：UI 每 1 → 着色器 0.01：`thickness = ui_value * 0.01` → 写入 `rings.thicknesses[X-1]`

  * 构造字典：`{"colors": [...], "thicknesses": [...], "count": N}` → `波纹.set_rings_config(dict)`。

* 心设置：

  * 填充颜色 → `心.set_colors(fill, inner, outer)` 的第一个参数；

  * 内边框颜色与宽度：颜色传第二参，宽度 SpinBox 值直接作为像素宽度传入 `心.set_strokes(inner_w, outer_w, softness)`；

  * 外边框颜色与宽度：颜色传第三参，宽度同上。

## 代码实现步骤（hypnosis\_app.gd）

1. 获取并缓存主要子节点与设置面板控件（使用唯一名 `%控件名` 便捷路径）。
2. 在 `_ready()`：

   * 连接各控件的 `toggled` / `value_changed` / `color_changed` 信号到本脚本的处理函数。

   * 读取当前控件值，初始化“波纹”与“心”的脚本导出的参数（调用它们已提供的方法）。

   * 连接 `get_viewport().size_changed` 信号并调用一次尺寸同步。
3. 尺寸同步：

   * 取 `get_viewport().size` → 调用 `波纹.target_size = size`、`波纹.follow_rect_for_tex = true`，并执行其 `_apply_layout()` 与 `_apply_mode_and_params()`；

   * 保留现有心布局；如需要，也可选在设置中增加“心跟随窗口大小”开关。
4. 颜色选项可见性管理：

   * 根据 `颜色数量` 的值显示/隐藏 `颜色选项3/4` 容器；

   * 在纯色模式时强制仅显示“颜色选项1”。
5. 构造并写入 `rings`：

   * 从已显示的颜色选项中收集 `ColorPickerButton.color` 与 `SpinBox.value * 0.01`；

   * 调用 `波纹.set_rings_config(dict)`。
6. 心设置应用：

   * 从三项颜色的 `ColorPickerButton.color` 与两项宽度 SpinBox 获取值，调用 `心.set_colors(...)` 与 `心.set_strokes(...)`。
7. 细节与健壮性：

   * 在切换纯色模式时，保持 `颜色数量` 的 UI 值但暂不写入着色器；

   * 防止越界：颜色数量最大不超过 4（UI），最终传入的 `count` 也需 clamp 到 `colors.size` 与着色器的 `MAX_COLORS`。

## 验证

* 启动时窗口大小应用到波纹；手动调整窗口大小，观察波纹控件与动画等比更新。

* 切换全屏/窗口化即刻生效。

* 切换“心”可见与“心跳”开关，效果立即作用于心形。

* 调整心跳速度/幅度，按 0.1 步进对应 0.01 的着色器值，动画节奏与强度变化应线性可感。

* 切换纯色模式后仅显示颜色选项 1，波纹背景使用该颜色纯填充；退出纯色恢复多段配置。

* 调整“颜色数量”与各颜色及厚度，波纹段数与视觉环宽变化正确。

* 心颜色与边框宽度实时更新，内外边框在心形内部/外部分别生效。

## 扩展（可选）

* 增加“心跟随窗口大小”开关；

* 增加“低功耗模式”开关以关闭心的光晕与脉动并降低采样步数；

* 将当前设置保存/载入为项目配置或保存文件。

